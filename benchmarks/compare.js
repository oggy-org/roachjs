/**
 * @module benchmarks/compare
 * @description Compare benchmark results between RoachJS, Fastify, and Express.
 * Reads results from benchmarks/results.json (generated by run.js) and outputs
 * a nicely formatted comparison table.
 *
 * Usage: node benchmarks/compare.js
 */

import { readFileSync, existsSync } from 'node:fs'
import { fileURLToPath } from 'node:url'
import { dirname, join } from 'node:path'

const __dirname = dirname(fileURLToPath(import.meta.url))
const resultsPath = join(__dirname, 'results.json')

/**
 * @description Format a number with commas and rounding.
 * @param {number} num - Number to format
 * @returns {string} Formatted string
 */
function fmt(num) {
    return Math.round(num).toLocaleString('en-US')
}

/**
 * @description Pad a string to a fixed width.
 * @param {string} str - String to pad
 * @param {number} len - Target length
 * @returns {string} Padded string
 */
function pad(str, len) {
    return str.padEnd(len)
}

/**
 * @description Right-pad a string.
 * @param {string} str - String to pad
 * @param {number} len - Target length
 * @returns {string} Padded string
 */
function rpad(str, len) {
    return str.padStart(len)
}

function main() {
    if (!existsSync(resultsPath)) {
        console.error('No benchmark results found. Run "npm run benchmark" first.')
        process.exit(1)
    }

    const results = JSON.parse(readFileSync(resultsPath, 'utf-8'))

    console.log()
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—')
    console.log('â•‘                  RoachJS Benchmark Comparison ðŸª³                  â•‘')
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log()
    console.log(`  Config: ${results.config.duration}s duration, ${results.config.connections} connections, ${results.config.pipelining} pipelining`)
    console.log(`  Date: ${results.timestamp}`)
    console.log()

    const header = `  ${pad('Framework', 12)} ${rpad('Req/sec', 12)} ${rpad('Latency Avg', 14)} ${rpad('Latency P99', 14)} ${rpad('Multiplier', 12)}`
    const sep = '  ' + 'â”€'.repeat(header.length - 2)

    console.log(header)
    console.log(sep)

    const frameworks = [
        { name: 'RoachJS', data: results.roachjs, color: '\x1b[32m' },
        { name: 'Fastify', data: results.fastify, color: '\x1b[33m' },
        { name: 'Express', data: results.express, color: '\x1b[31m' }
    ]

    const maxReqSec = Math.max(...frameworks.map(f => f.data.requestsPerSec))

    for (const fw of frameworks) {
        const multiplier = fw.data.requestsPerSec > 0
            ? `${(fw.data.requestsPerSec / (frameworks[2].data.requestsPerSec || 1)).toFixed(1)}x`
            : 'N/A'

        console.log(
            `  ${fw.color}${pad(fw.name, 12)}\x1b[0m` +
            `${rpad(fmt(fw.data.requestsPerSec), 12)} ` +
            `${rpad(fw.data.latencyAvg.toFixed(2) + 'ms', 14)} ` +
            `${rpad(fw.data.latencyP99.toFixed(2) + 'ms', 14)} ` +
            `${rpad(multiplier, 12)}`
        )
    }

    console.log(sep)
    console.log()

    if (results.roachjs.requestsPerSec > 0 && results.fastify.requestsPerSec > 0) {
        const fRatio = (results.roachjs.requestsPerSec / results.fastify.requestsPerSec).toFixed(1)
        console.log(`  âš¡ RoachJS is ${fRatio}x faster than Fastify`)
    }
    if (results.roachjs.requestsPerSec > 0 && results.express.requestsPerSec > 0) {
        const eRatio = (results.roachjs.requestsPerSec / results.express.requestsPerSec).toFixed(1)
        console.log(`  âš¡ RoachJS is ${eRatio}x faster than Express`)
    }
    console.log()
}

main()
